name: "Leonidas"
description: "Issue-to-PR automation powered by Claude Code"
author: "JeremyDev87"

branding:
  icon: "zap"
  color: "orange"

inputs:
  mode:
    description: "Operation mode: 'plan' or 'execute'"
    required: true
  anthropic_api_key:
    description: "Anthropic API key for Claude Code"
    required: true
  github_token:
    description: "GitHub token for API access"
    required: true
  model:
    description: "Claude model to use (overrides config)"
    required: false
  max_turns:
    description: "Maximum turns for Claude Code (overrides config)"
    required: false
  allowed_tools:
    description: "Comma-separated allowed tools (overrides config)"
    required: false
  branch_prefix:
    description: "Branch name prefix for PRs (overrides config)"
    required: false
  base_branch:
    description: "Base branch for PRs (overrides config)"
    required: false
  language:
    description: "Language for plan comments (overrides config)"
    required: false
  config_path:
    description: "Path to leonidas.config.yml"
    required: false
    default: "leonidas.config.yml"
  system_prompt_path:
    description: "Path to custom system prompt file"
    required: false
    default: ".github/leonidas.md"
  rules_path:
    description: "Path to rules directory containing .md files"
    required: false
    default: ".github/leonidas-rules"

outputs:
  conclusion:
    description: "Conclusion from Claude Code execution"
    value: ${{ steps.claude.outputs.conclusion }}
  execution_file:
    description: "Path to execution output file"
    value: ${{ steps.claude.outputs.execution_file }}
  branch_prefix:
    description: "Branch prefix used for this run"
    value: ${{ steps.prepare.outputs.branch_prefix }}
  base_branch:
    description: "Base branch used for this run"
    value: ${{ steps.prepare.outputs.base_branch }}
  language:
    description: "Language used for this run"
    value: ${{ steps.prepare.outputs.language }}

runs:
  using: "composite"
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install action dependencies
      shell: bash
      run: npm ci --prefix ${{ github.action_path }}

    - name: Build action
      shell: bash
      run: npm run build --prefix ${{ github.action_path }}

    - name: Prepare
      id: prepare
      shell: bash
      env:
        INPUT_MODE: ${{ inputs.mode }}
        INPUT_ANTHROPIC_API_KEY: ${{ inputs.anthropic_api_key }}
        INPUT_GITHUB_TOKEN: ${{ inputs.github_token }}
        INPUT_MODEL: ${{ inputs.model }}
        INPUT_MAX_TURNS: ${{ inputs.max_turns }}
        INPUT_ALLOWED_TOOLS: ${{ inputs.allowed_tools }}
        INPUT_BRANCH_PREFIX: ${{ inputs.branch_prefix }}
        INPUT_BASE_BRANCH: ${{ inputs.base_branch }}
        INPUT_LANGUAGE: ${{ inputs.language }}
        INPUT_CONFIG_PATH: ${{ inputs.config_path }}
        INPUT_SYSTEM_PROMPT_PATH: ${{ inputs.system_prompt_path }}
        INPUT_RULES_PATH: ${{ inputs.rules_path }}
      run: node ${{ github.action_path }}/dist/index.js

    - name: Run Claude Code
      id: claude
      uses: anthropics/claude-code-action/base-action@v1
      env:
        ANTHROPIC_MODEL: ${{ steps.prepare.outputs.model }}
        INPUT_MAX_TURNS: ${{ steps.prepare.outputs.max_turns }}
        INPUT_ALLOWED_TOOLS: ${{ steps.prepare.outputs.allowed_tools }}
        GH_TOKEN: ${{ inputs.github_token }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
      with:
        prompt_file: ${{ steps.prepare.outputs.prompt_file }}
        anthropic_api_key: ${{ inputs.anthropic_api_key }}
        show_full_output: "true"
        use_node_cache: "false"

    - name: Cleanup prompt file
      if: always()
      shell: bash
      run: rm -f "${{ steps.prepare.outputs.prompt_file }}"

    - name: Link native sub-issues (if decomposed)
      if: inputs.mode == 'plan' && !failure()
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        REPO: ${{ github.repository }}
      run: node dist/post_process/index.js link-subissues

    - name: Post completion comment
      if: inputs.mode == 'execute' && !failure()
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        LANGUAGE: ${{ steps.prepare.outputs.language }}
        BRANCH_PREFIX: ${{ steps.prepare.outputs.branch_prefix }}
        RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      run: node dist/post_process/index.js post-completion

    - name: Rescue partial progress
      id: rescue
      if: failure() && inputs.mode == 'execute'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        BRANCH_PREFIX: ${{ steps.prepare.outputs.branch_prefix }}
        BASE_BRANCH: ${{ steps.prepare.outputs.base_branch }}
        LANGUAGE: ${{ steps.prepare.outputs.language }}
        RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      run: node dist/post_process/index.js rescue

    - name: Post failure comment
      if: failure() && steps.rescue.outputs.branch_exists != 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        LANGUAGE: ${{ steps.prepare.outputs.language }}
        RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        MODE: ${{ inputs.mode }}
      run: node dist/post_process/index.js post-failure

    - name: Post-process PR
      if: always() && inputs.mode == 'execute'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        BRANCH_PREFIX: ${{ steps.prepare.outputs.branch_prefix }}
      run: node dist/post_process/index.js post-process-pr

    - name: Trigger CI on PR branch
      if: always() && inputs.mode == 'execute'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        BRANCH_PREFIX: ${{ steps.prepare.outputs.branch_prefix }}
      run: node dist/post_process/index.js trigger-ci
